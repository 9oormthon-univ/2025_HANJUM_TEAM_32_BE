on:
  push:
    branches: [ main ] 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest 
    steps:
    - name: 소스코드 체크아웃
      uses: actions/checkout@v3

    - name: JDK 17 설치
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'corretto'

    - name: Gradle로 빌드하기
      run: ./gradlew build

    - name: SSH로 EC2에 접속해서 배포하기
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AWS_HOST }} 
        username: ubuntu
        key: ${{ secrets.AWS_PEM_KEY }} 
        script: |
            cd /home/ubuntu/2025_HANJUM_TEAM_32_BE
            git pull origin main
            export GRADLE_OPTS="-Xmx1024m"
            ./gradlew clean build -x test
            pgrep -f '.jar' | xargs -r kill -9
            nohup java -jar build/libs/*.jar &

